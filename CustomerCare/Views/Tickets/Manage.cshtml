@model CustomerCare.Models.ViewModels.PagedResult<CustomerCare.Models.Entities.Ticket>
@using CustomerCare.Models.Entities
@using CustomerCare.Models.Enums
@using CustomerCare.Helpers

@{
    ViewData["Title"] = "Ticket Management";

    var categories = ViewBag.Categories as List<TicketCategory>;

    TicketStatus? selectedStatus = ViewBag.SelectedStatus != null
        ? (TicketStatus)ViewBag.SelectedStatus
        : (TicketStatus?)null;

    TicketPriority? selectedPriority = ViewBag.SelectedPriority != null
        ? (TicketPriority)ViewBag.SelectedPriority
        : (TicketPriority?)null;

    int? selectedCategoryId = ViewBag.SelectedCategoryId != null
        ? (int)ViewBag.SelectedCategoryId
        : (int?)null;

    string search = ViewBag.Search as string;
}

<h2>Support – Ticket Management</h2>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link active"
           asp-controller="Tickets"
           asp-action="Manage">
            All Tickets
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link"
           asp-controller="Tickets"
           asp-action="MyAssigned">
            My Assigned
        </a>
    </li>
</ul>

<div class="card">
    <div class="card-header">
        <form method="get" class="row g-2 mb-0">
            <div class="col-md-3">
                <label class="form-label mb-1">Status</label>
                <select name="status" class="form-select form-select-sm">
                    <option value="">All</option>
                    @foreach (TicketStatus st in Enum.GetValues(typeof(TicketStatus)))
                    {
                        <option value="@st"
                                selected="@(selectedStatus.HasValue && st == selectedStatus.Value ? "selected" : null)">
                            @st
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label mb-1">Priority</label>
                <select name="priority" class="form-select form-select-sm">
                    <option value="">All</option>
                    @foreach (TicketPriority pr in Enum.GetValues(typeof(TicketPriority)))
                    {
                        <option value="@pr"
                                selected="@(selectedPriority.HasValue && pr == selectedPriority.Value ? "selected" : null)">
                            @pr
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label mb-1">Category</label>
                <select name="categoryId" class="form-select form-select-sm">
                    <option value="">All</option>
                    @if (categories != null)
                    {
                        foreach (var cat in categories)
                        {
                            <option value="@cat.Id"
                                    selected="@(selectedCategoryId.HasValue && cat.Id == selectedCategoryId.Value ? "selected" : null)">
                                @cat.Name
                            </option>
                        }
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label mb-1">Search</label>
                <input type="text"
                       name="search"
                       value="@search"
                       class="form-control form-control-sm"
                       placeholder="Title / description / user email" />
            </div>

            <div class="col-12 mt-2">
                <button type="submit" class="btn btn-sm btn-primary">Filter</button>
                <a asp-action="Manage" class="btn btn-sm btn-secondary">Clear</a>
            </div>
        </form>
    </div>

    <div class="card-body p-0">
        <table class="table table-striped table-sm mb-0">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Title</th>
                    <th>Created By</th>
                    <th>Assigned To</th>
                    <th>Category</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Created At (UTC)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>@item.Id</td>
                        <td>@item.Title</td>
                        <td>@item.CreatedBy?.Email</td>
                        <td>@(item.AssignedTo?.Email ?? "-")</td>
                        <td>@item.Category?.Name</td>
                        <td>
                            <span class="@TicketUiHelper.GetPriorityBadgeClass(item.Priority)">
                                @item.Priority
                            </span>
                        </td>
                        <td>
                            <span class="@TicketUiHelper.GetStatusBadgeClass(item.Status)">
                                @item.Status
                            </span>
                        </td>
                        <td>@item.CreatedAt</td>
                        <td>
                            @* Assign to me if unassigned *@
                            @if (item.AssignedToId == null)
                            {
                                <form asp-action="AssignToMe" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@item.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        Assign to me
                                    </button>
                                </form>
                            }

                            @* Status change *@
                            <form asp-action="ChangeStatus" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@item.Id" />
                                <select name="status" class="form-select form-select-sm d-inline w-auto">
                                    @foreach (TicketStatus st in Enum.GetValues(typeof(TicketStatus)))
                                    {
                                        <option value="@st"
                                                selected="@(st == item.Status ? "selected" : null)">
                                            @st
                                        </option>
                                    }
                                </select>
                                <button type="submit" class="btn btn-sm btn-outline-secondary">
                                    Update
                                </button>
                            </form>

                            <a asp-action="Details"
                               asp-route-id="@item.Id"
                               class="btn btn-sm btn-link">
                                Details
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (Model.TotalPages > 1)
    {
        <div class="card-footer">
            <nav aria-label="Ticket pages">
                <ul class="pagination mb-0">

                    <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                        @if (Model.HasPreviousPage)
                        {
                            <a class="page-link"
                               asp-action="Manage"
                               asp-route-page="@(Model.Page - 1)"
                               asp-route-status="@selectedStatus"
                               asp-route-priority="@selectedPriority"
                               asp-route-categoryId="@selectedCategoryId"
                               asp-route-search="@search">
                                Previous
                            </a>
                        }
                        else
                        {
                            <span class="page-link">Previous</span>
                        }
                    </li>

                    @for (int p = 1; p <= Model.TotalPages; p++)
                    {
                        <li class="page-item @(p == Model.Page ? "active" : "")">
                            <a class="page-link"
                               asp-action="Manage"
                               asp-route-page="@p"
                               asp-route-status="@selectedStatus"
                               asp-route-priority="@selectedPriority"
                               asp-route-categoryId="@selectedCategoryId"
                               asp-route-search="@search">
                                @p
                            </a>
                        </li>
                    }

                    <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                        @if (Model.HasNextPage)
                        {
                            <a class="page-link"
                               asp-action="Manage"
                               asp-route-page="@(Model.Page + 1)"
                               asp-route-status="@selectedStatus"
                               asp-route-priority="@selectedPriority"
                               asp-route-categoryId="@selectedCategoryId"
                               asp-route-search="@search">
                                Next
                            </a>
                        }
                        else
                        {
                            <span class="page-link">Next</span>
                        }
                    </li>

                </ul>
            </nav>
        </div>
    }
</div>
